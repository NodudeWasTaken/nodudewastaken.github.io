(function(){"use strict";function v(t,i,o){const r=[];for(let n=0;n<=t.length-i;n+=o){let p=0;for(let a=0;a<i;a++)p+=t[n+a]*t[n+a];r.push(Math.sqrt(p/i))}return r}function T(t,i,o){const r=[],a=i/1e3,M=i/50;for(let h=0;h<=t.length-o;h+=o){const c=t.slice(h,h+o);if(c.length<o)break;let e=.01,f=new Array(o).fill(0);for(let s=0;s<o;s++)for(let g=0;g<o-s;g++)f[s]+=c[g]*c[g+s];let m=0,u=0;const d=Math.max(2,Math.floor(a)),y=Math.min(o-1,Math.ceil(M));for(let s=d;s<y;s++)f[s]>m&&(m=f[s],u=s);u>0&&(e=i/u),r.push(Math.max(.01,e))}return r}function k(t,i,o){const r=[];for(let n=0;n<t;n++)r.push(n*o/i);return r}function F(t,i,o,r){const n=[],p=k(t.length,i,o);let a=0;if(t.length>0){a=t[0];for(let e=1;e<t.length;e++)t[e]>a&&(a=t[e])}const M=.2*a,h=.3;let c=-1/0;for(let e=1;e<t.length-1;e++)if(t[e]>M&&t[e]>t[e-1]&&t[e]>t[e+1]){const f=p[e];f-c>h&&(n.push(f),c=f)}return n}self.onmessage=async t=>{const{type:i,payload:o}=t.data;if(i==="processAudio"){const{channelData:r,sampleRate:n,duration:p,hopLength:a,frameLength:M,plp:h}=o;try{self.postMessage({type:"progress",value:10,message:"Processing RMS..."});const c=v(r,M,a);self.postMessage({type:"progress",value:40,message:"Processing Pitch..."});const e=T(r,n,a),f=Math.min(c.length,e.length),m=c.slice(0,f),u=e.slice(0,f);self.postMessage({type:"progress",value:70,message:"Processing Beats..."});const d=F(m,n,a,p),y=k(m.length,n,a),s=[0];let g=0;for(let l=0;l<y.length&&!(g>=d.length);l++)y[l]>d[g]&&(g>0&&s.push(l),g++);s.push(-1);const x=[],R=[];for(let l=1;l<s.length;l++){const j=s[l-1],A=s[l]===-1?u.length:s[l];let b=0,q=0;for(let P=j;P<A;P++)b+=u[P],q+=m[P];x.push(b),R.push(q)}const S=x.map(l=>Math.log10(Math.max(.01,l)));self.postMessage({type:"progress",value:90,message:"Collecting results..."}),self.postMessage({type:"audioDataReady",data:{at:p,beats:d,pitch:S,energy:R}})}catch(c){console.error("Audio processing worker failed:",c),self.postMessage({type:"error",message:c.message})}}}})();
