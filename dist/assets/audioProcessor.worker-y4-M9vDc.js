(function(){"use strict";function v(t,a,s){const r=[];for(let o=0;o<=t.length-a;o+=s){let m=0;for(let i=0;i<a;i++)m+=t[o+i]*t[o+i];r.push(Math.sqrt(m/a))}return r}function S(t,a,s){const r=[],i=a/1e3,M=a/50;for(let p=0;p<=t.length-s;p+=s){const c=t.slice(p,p+s);if(c.length<s)break;let n=.01,f=new Array(s).fill(0);for(let e=0;e<s;e++)for(let g=0;g<s-e;g++)f[e]+=c[g]*c[g+e];let u=0,h=0;const d=Math.max(2,Math.floor(i)),y=Math.min(s-1,Math.ceil(M));for(let e=d;e<y;e++)f[e]>u&&(u=f[e],h=e);h>0&&(n=a/h),r.push(Math.max(.01,n))}return r}function x(t,a,s){const r=[];for(let o=0;o<t;o++)r.push(o*s/a);return r}function T(t,a,s,r){const o=[],m=x(t.length,a,s),M=.2*(t.length>0?Math.max(...t):0),p=.3;let c=-1/0;for(let n=1;n<t.length-1;n++)if(t[n]>M&&t[n]>t[n-1]&&t[n]>t[n+1]){const f=m[n];f-c>p&&(o.push(f),c=f)}return o}self.onmessage=async t=>{const{type:a,payload:s}=t.data;if(a==="processAudio"){const{channelData:r,sampleRate:o,duration:m,hopLength:i,frameLength:M,plp:p}=s;try{self.postMessage({type:"progress",value:10,message:"Processing RMS..."});const c=v(r,M,i);self.postMessage({type:"progress",value:40,message:"Processing Pitch..."});const n=S(r,o,i),f=Math.min(c.length,n.length),u=c.slice(0,f),h=n.slice(0,f);self.postMessage({type:"progress",value:70,message:"Processing Beats..."});const d=T(u,o,i,m),y=x(u.length,o,i),e=[0];let g=0;for(let l=0;l<y.length&&!(g>=d.length);l++)y[l]>d[g]&&(g>0&&e.push(l),g++);e.push(-1);const R=[],k=[];for(let l=1;l<e.length;l++){const j=e[l-1],A=e[l]===-1?h.length:e[l];let b=0,q=0;for(let P=j;P<A;P++)b+=h[P],q+=u[P];R.push(b),k.push(q)}const F=R.map(l=>Math.log10(Math.max(.01,l)));self.postMessage({type:"progress",value:90,message:"Collecting results..."}),self.postMessage({type:"audioDataReady",data:{at:m,beats:d,pitch:F,energy:k}})}catch(c){console.error("Audio processing worker failed:",c),self.postMessage({type:"error",message:c.message})}}}})();
